<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaudhary Oil Agencies - Solar & Automotive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Link to our external CSS file -->
    <link rel="stylesheet" href="styles.css">
</head>
<body class="p-6 md:p-12">
    <div class="max-w-7xl mx-auto">
        <header class="header-bg rounded-lg mb-12 py-4 px-6 md:px-10 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Chaudhary Oil Agencies</h1>
            <nav class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-6">
                <a href="#" class="nav-item" id="products-link">Products</a>
                <a href="#" class="nav-item" id="calculator-link">Calculator</a>
                <a href="#" class="nav-item" id="contact-link">Contact Us</a>
                <a href="#" class="nav-item" id="about-link">About Us</a>
                <button id="login-btn" class="nav-item">Login</button>
                <a href="#" class="nav-item relative hidden" id="cart-link">
                    Cart (<span id="cart-count">0</span>)
                </a>
                <a href="#" class="nav-item hidden" id="admin-link">Admin</a>
                <a href="#" class="nav-item hidden" id="dealers-link">Dealers</a>
                <button id="logout-btn" class="nav-item hidden">Logout</button>
            </nav>
        </header>

        <!-- Main Website Sections -->
        <div id="main-content">
            <section id="product-gallery-section">
                <h2 class="section-title">Our Products</h2>
                <div class="flex space-x-4 mb-8 justify-center" id="filter-buttons">
                    <button class="btn btn-secondary filter-button active" data-filter="all">All</button>
                    <button class="btn btn-secondary filter-button" data-filter="solar">Solar</button>
                    <button class="btn btn-secondary filter-button" data-filter="automotive">Automotive</button>
                </div>
                <div id="product-gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                </div>
            </section>

            <section id="product-details-section" class="hidden">
                <button id="back-to-products-btn" class="btn btn-secondary mb-8">&larr; Back to Products</button>
                <div class="bg-white p-8 rounded-lg shadow-md flex flex-col md:flex-row md:space-x-8 space-y-8 md:space-y-0">
                    <div class="md:w-1/2">
                        <img id="product-main-image" src="" alt="" class="w-full h-auto rounded-lg mb-4">
                        <div id="product-thumbnails" class="flex space-x-2 overflow-x-auto">
                        </div>
                    </div>
                    <div class="md:w-1/2 mt-8 md:mt-0">
                        <h1 id="product-details-name" class="text-3xl font-bold text-gray-800"></h1>
                        <p id="product-details-category" class="text-lg text-gray-600 mt-2"></p>
                        <p id="product-details-price" class="text-4xl font-bold text-green-600 my-4"></p>
                        <p id="product-details-description" class="text-gray-700 leading-relaxed"></p>
                        <button id="add-to-cart-details-btn" class="btn btn-primary w-full mt-8">Add to Cart</button>
                    </div>
                </div>
            </section>

            <section id="checkout-section" class="hidden mb-12">
                <h2 class="section-title">Checkout</h2>
                <div class="form-container flex flex-col md:flex-row md:space-x-8 space-y-8 md:space-y-0">
                    <div class="md:w-1/2">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Order Summary</h3>
                        <div id="checkout-summary" class="space-y-4 text-base">
                        </div>
                        <div id="checkout-total" class="mt-6 text-right text-2xl font-bold text-gray-800 border-t pt-6">
                            Total: ₹0
                        </div>
                    </div>
                    <div class="md:w-1/2 mt-10 md:mt-0">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Customer Information</h3>
                        <form id="checkout-form" class="space-y-4">
                            <div>
                                <label for="name" class="block text-gray-700 font-medium mb-2">Full Name</label>
                                <input type="text" id="name" class="form-input" required>
                            </div>
                            <div>
                                <label for="email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                                <input type="email" id="email" class="form-input" required>
                            </div>
                            <div>
                                <label for="address" class="block text-gray-700 font-medium mb-2">Shipping Address</label>
                                <input type="text" id="address" class="form-input" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-full mt-6">Place Order</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="solar-calculator-section" class="hidden mb-12">
                <h2 class="section-title">Solar Power Load Calculator</h2>
                <div class="form-container max-w-2xl mx-auto">
                    <p class="text-gray-600 mb-6 text-lg text-center">Select the appliances you want to run on solar power to estimate your total load.</p>
                    <form id="solar-calculator-form" class="space-y-4">
                        <div id="appliance-list" class="space-y-4">
                            <!-- Appliances will be dynamically generated here -->
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-6">Calculate Required Power</button>
                    </form>
                    <div id="calculator-result" class="mt-8 text-center text-lg font-semibold text-gray-800">
                        <!-- Result will be displayed here -->
                    </div>
                </div>
            </section>

            <section id="contact-section" class="hidden mb-12">
                <h2 class="section-title">Contact Us</h2>
                <div class="form-container max-w-2xl mx-auto">
                    <p class="text-gray-600 mb-6 text-lg text-center">Have a question or need a quote? Fill out the form below and we'll get back to you as soon as possible.</p>
                    <form id="contact-form" class="space-y-4">
                        <div>
                            <label for="contact-name" class="block text-gray-700 font-medium mb-2">Your Name</label>
                            <input type="text" id="contact-name" class="form-input" required>
                        </div>
                        <div>
                            <label for="contact-email" class="block text-gray-700 font-medium mb-2">Email</label>
                            <input type="email" id="contact-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="contact-message" class="block text-gray-700 font-medium mb-2">Your Message</label>
                            <textarea id="contact-message" rows="5" class="form-textarea" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-6">Send Message</button>
                    </form>
                </div>
            </section>

            <section id="about-section" class="hidden mb-12">
                <h2 class="section-title">About Us</h2>
                <div class="form-container max-w-3xl mx-auto text-center">
                    <p class="text-xl text-gray-800 mb-6 leading-relaxed">
                        Welcome to Chaudhary Oil Agencies! We are dedicated to providing high-quality solar energy and automotive products to help you transition to a cleaner, more sustainable future and keep your vehicles running smoothly.
                    </p>
                    <p class="text-lg text-gray-600 mb-6 leading-relaxed">
                        Our mission is to make sustainable power accessible and affordable for everyone. We believe that by offering top-tier products and excellent service, we can empower our community to reduce its carbon footprint and ensure reliable performance.
                    </p>
                    <p class="text-lg text-gray-600 leading-relaxed">
                        From high-efficiency solar panels to reliable inverters, batteries, and a wide range of automotive essentials, our product selection is curated to meet the diverse needs of both residential, commercial, and vehicle owners.
                    </p>
                </div>
            </section>
        </div>

        <!-- Admin and Dealer Dashboard Sections -->
        <section id="admin-section" class="hidden mb-12">
            <h2 class="section-title">Admin Dashboard</h2>
            <div id="admin-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Products Management Card -->
                    <div class="form-container mb-10">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Add New Product</h3>
                        <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label for="new-product-name" class="block text-gray-700 font-medium mb-2">Product Name</label>
                                <input type="text" id="new-product-name" class="form-input" required>
                            </div>
                            <div>
                                <label for="new-product-price" class="block text-gray-700 font-medium mb-2">Price (₹)</label>
                                <input type="number" id="new-product-price" class="form-input" required>
                            </div>
                            <div>
                                <label for="new-product-category" class="block text-gray-700 font-medium mb-2">Category</label>
                                <select id="new-product-category" class="form-select" required>
                                    <option value="solar">Solar</option>
                                    <option value="automotive">Automotive</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="new-product-image-1" class="block text-gray-700 font-medium mb-2">Image URL 1 (Main)</label>
                                <input type="url" id="new-product-image-1" class="form-input" placeholder="https://via.placeholder.com/400x300" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="new-product-image-2" class="block text-gray-700 font-medium mb-2">Image URL 2</label>
                                <input type="url" id="new-product-image-2" class="form-input" placeholder="(Optional)">
                            </div>
                            <div class="md:col-span-2">
                                <label for="new-product-image-3" class="block text-gray-700 font-medium mb-2">Image URL 3</label>
                                <input type="url" id="new-product-image-3" class="form-input" placeholder="(Optional)">
                            </div>
                            <div class="md:col-span-2">
                                <label for="new-product-description" class="block text-gray-700 font-medium mb-2">Product Description</label>
                                <textarea id="new-product-description" rows="4" class="form-input" required></textarea>
                            </div>
                            <div class="md:col-span-2">
                                <button type="submit" class="btn btn-primary w-full mt-4">Add Product</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="form-container">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Manage Products</h3>
                        <div id="admin-product-list" class="space-y-4">
                        </div>
                    </div>
                </div>

                <!-- Dealer Creation Form -->
                <div class="form-container max-w-lg mx-auto mt-10">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Create New Dealer</h3>
                    <form id="create-dealer-form" class="space-y-4">
                        <div>
                            <label for="dealer-email" class="block text-gray-700 font-medium mb-2">Dealer Email</label>
                            <input type="email" id="dealer-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="dealer-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="dealer-password" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-4">Create Dealer Account</button>
                    </form>
                    <div id="dealer-creation-error" class="text-red-500 text-sm mt-2 hidden text-center"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                    <!-- Consumer Orders Card -->
                    <div class="form-container">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Consumer Orders</h3>
                        <div id="admin-orders-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>
                        <p id="no-orders-message" class="text-center text-gray-600 hidden">No orders submitted yet.</p>
                    </div>

                    <!-- Customer Complaints Card -->
                    <div class="form-container">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Customer Complaints</h3>
                        <div id="admin-complaints-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>
                        <p id="no-complaints-message" class="text-center text-gray-600 hidden">No complaints submitted yet.</p>
                    </div>
                </div>
                <button id="admin-logout-btn" class="btn btn-secondary w-full max-w-xs mx-auto block mt-8">Logout Admin</button>
            </div>
        </section>

        <section id="dealers-section" class="hidden mb-12">
            <h2 class="section-title">Dealers Dashboard</h2>
            <div id="dealers-content" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                    <!-- Consumer Orders Card for Dealers -->
                    <div class="form-container">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Consumer Orders</h3>
                        <div id="dealers-orders-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>
                        <p id="dealers-no-orders-message" class="text-center text-gray-600 hidden">No orders submitted yet.</p>
                    </div>

                    <!-- Customer Complaints Card for Dealers -->
                    <div class="form-container">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6">Customer Complaints</h3>
                        <div id="dealers-complaints-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        </div>
                        <p id="dealers-no-complaints-message" class="text-center text-gray-600 hidden">No complaints submitted yet.</p>
                    </div>
                </div>
                <button id="dealers-logout-btn" class="btn btn-secondary w-full max-w-xs mx-auto block mt-8">Logout</button>
            </div>
        </section>

        <div id="cart-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="modal-content w-full max-w-lg p-8">
                <div class="text-center">
                    <h3 class="text-3xl font-bold text-gray-900 mb-6">Your Shopping Cart</h3>
                    <div id="cart-items" class="mt-4 text-left space-y-4 max-h-96 overflow-y-auto pr-2">
                    </div>
                    <div id="cart-total" class="mt-8 text-right text-2xl font-bold text-gray-800 border-t pt-6">
                        Total: ₹0
                    </div>
                    <div class="mt-10 flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                        <button id="close-cart-btn" class="btn btn-secondary flex-1">Continue Shopping</button>
                        <button id="checkout-btn" class="btn btn-primary flex-1">Proceed to Checkout</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Login Modal -->
        <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
            <div class="modal-content w-full max-w-2xl p-8 space-y-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-3xl font-bold text-gray-900">Login</h3>
                    <button id="close-login-modal" class="text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <div id="login-options-container" class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button id="show-consumer-login-btn" class="btn btn-primary">Consumer Login</button>
                        <button id="show-otp-login-btn" class="btn btn-primary">Login with OTP</button>
                        <button id="show-admin-login-btn" class="btn btn-secondary">Admin Login</button>
                        <button id="show-dealer-login-btn" class="btn btn-secondary">Dealer Login</button>
                    </div>
                </div>

                <!-- Consumer Login/Signup Card -->
                <div id="consumer-login-card" class="form-container hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Consumer Login</h3>
                    <p class="text-center text-gray-600 mb-6">Login with your email or sign up for a new account.</p>
                    <form id="consumer-login-form" class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                            <input type="email" id="login-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="login-password" class="form-input" required>
                        </div>
                        <p id="consumer-login-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
                        <button type="submit" class="btn btn-primary w-full mt-4">Login</button>
                    </form>
                    <p class="text-center text-gray-600 my-4">Don't have an account? <a href="#" id="show-signup-form" class="text-blue-600 hover:underline">Sign up here.</a></p>
                </div>

                <!-- Consumer Signup Form -->
                <div id="consumer-signup-card" class="form-container hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">New User Signup</h3>
                    <p class="text-center text-gray-600 mb-6">Create a new account with your email and a strong password.</p>
                    <form id="consumer-signup-form" class="space-y-4">
                        <div>
                            <label for="signup-email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                            <input type="email" id="signup-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="signup-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="signup-password" class="form-input" required>
                        </div>
                        <p id="consumer-signup-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
                        <button type="submit" class="btn btn-primary w-full mt-4">Sign Up</button>
                    </form>
                    <p class="text-center text-gray-600 my-4">Already have an account? <a href="#" id="show-login-form" class="text-blue-600 hover:underline">Login here.</a></p>
                </div>

                <!-- OTP Login Card -->
                <div id="otp-login-card" class="form-container hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login with OTP</h3>
                    <p class="text-center text-gray-600 mb-6">Enter your phone number to receive a one-time login code.</p>
                    <form id="otp-form" class="space-y-4">
                        <div id="phone-input-container">
                            <label for="phone-number" class="block text-gray-700 font-medium mb-2">Phone Number</label>
                            <input type="tel" id="phone-number" class="form-input" placeholder="+919876543210" required>
                            <div id="recaptcha-container" class="mt-4"></div>
                            <button type="submit" id="send-otp-btn" class="btn btn-primary w-full mt-4">Send OTP</button>
                        </div>
                        <div id="otp-input-container" class="hidden">
                            <label for="otp-code" class="block text-gray-700 font-medium mb-2">Verification Code</label>
                            <input type="text" id="otp-code" class="form-input" placeholder="Enter 6-digit code" required>
                            <button type="submit" id="verify-otp-btn" class="btn btn-primary w-full mt-4">Verify OTP</button>
                        </div>
                    </form>
                    <p id="otp-error-message" class="text-red-500 text-sm mt-2 hidden text-center"></p>
                </div>

                <!-- Admin Login Card -->
                <div id="admin-login-card" class="form-container hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Owner Login</h3>
                    <form id="admin-login-form" class="space-y-4">
                        <div>
                            <label for="admin-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="admin-password" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-4">Login to Admin</button>
                        <p id="admin-login-error" class="text-red-500 text-sm mt-2 hidden text-center">Incorrect password.</p>
                    </form>
                </div>
                
                <!-- Dealer Login Card -->
                <div id="dealer-login-card" class="form-container hidden">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Dealer Login</h3>
                    <p class="text-center text-gray-600 mb-6">Login with your assigned email and password.</p>
                    <form id="dealers-login-form" class="space-y-4">
                        <div>
                            <label for="dealers-email" class="block text-gray-700 font-medium mb-2">Email Address</label>
                            <input type="email" id="dealers-email" class="form-input" required>
                        </div>
                        <div>
                            <label for="dealers-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="dealers-password" class="form-input" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-full mt-4">Login to Dealers</button>
                        <p id="dealers-login-error" class="text-red-500 text-sm mt-2 hidden text-center">Invalid email or password.</p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Custom Message Box to replace alerts -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
            <div class="modal-content w-full max-w-sm p-8">
                <div class="text-center">
                    <p id="message-text" class="text-gray-800 text-lg font-medium mb-6"></p>
                    <button id="message-box-ok-btn" class="btn btn-primary w-full">OK</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-12 text-center text-gray-500 text-sm">
        &copy; 2025 Chaudhary Oil Agencies. All rights reserved.
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCuQEZZJplC6jWHlcTzbmuNhOYfvihpn5E",
            authDomain: "chaudhary-cleanenergy-183a8.firebaseapp.com",
            projectId: "chaudhary-cleanenergy-183a8",
            storageBucket: "chaudhary-cleanenergy-183a8.firebasestorage.app",
            messagingSenderId: "84964892092",
            appId: "1:84964892092:web:eda197231667904f81dfb9",
            measurementId: "G-N44TD7MXZK"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        let confirmationResult = null; // To store the confirmation result for OTP verification
        
        let products = [];
        
        const ADMIN_PASSWORD = 'password123';
        let cart = JSON.parse(localStorage.getItem('solarCart')) || {};
        
        // Element references
        const cartCountElement = document.getElementById('cart-count');
        const productGallery = document.getElementById('product-gallery');
        const productDetailsSection = document.getElementById('product-details-section');
        const backToProductsBtn = document.getElementById('back-to-products-btn');
        const productMainImage = document.getElementById('product-main-image');
        const productThumbnails = document.getElementById('product-thumbnails');
        const productDetailsName = document.getElementById('product-details-name');
        const productDetailsCategory = document.getElementById('product-details-category');
        const productDetailsPrice = document.getElementById('product-details-price');
        const productDetailsDescription = document.getElementById('product-details-description');
        const addToCartDetailsBtn = document.getElementById('add-to-cart-details-btn');
        const cartModal = document.getElementById('cart-modal');
        const closeCartBtn = document.getElementById('close-cart-btn');
        const cartItemsContainer = document.getElementById('cart-items');
        const cartTotalElement = document.getElementById('cart-total');
        const cartLink = document.getElementById('cart-link');
        const modalCheckoutBtn = document.getElementById('checkout-btn');
        const productsLink = document.getElementById('products-link');
        const calculatorLink = document.getElementById('calculator-link');
        const contactLink = document.getElementById('contact-link');
        const aboutLink = document.getElementById('about-link');
        const adminLink = document.getElementById('admin-link');
        const dealersLink = document.getElementById('dealers-link');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const mainContent = document.getElementById('main-content');
        
        const loginModal = document.getElementById('login-modal');
        const closeLoginModalBtn = document.getElementById('close-login-modal');
        const loginOptionsContainer = document.getElementById('login-options-container');
        const consumerLoginCard = document.getElementById('consumer-login-card');
        const consumerSignupCard = document.getElementById('consumer-signup-card');
        const otpLoginCard = document.getElementById('otp-login-card');
        const adminLoginCard = document.getElementById('admin-login-card');
        const dealerLoginCard = document.getElementById('dealer-login-card');
        
        const showConsumerLoginBtn = document.getElementById('show-consumer-login-btn');
        const showOtpLoginBtn = document.getElementById('show-otp-login-btn');
        const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
        const showDealerLoginBtn = document.getElementById('show-dealer-login-btn');
        const showSignupFormBtn = document.getElementById('show-signup-form');
        const showLoginFormBtn = document.getElementById('show-login-form');
        const consumerLoginForm = document.getElementById('consumer-login-form');
        const consumerSignupForm = document.getElementById('consumer-signup-form');
        const consumerLoginErrorMsg = document.getElementById('consumer-login-error');
        const consumerSignupErrorMsg = document.getElementById('consumer-signup-error');
        
        const otpForm = document.getElementById('otp-form');
        const phoneNumberInput = document.getElementById('phone-number');
        const phoneInputContainer = document.getElementById('phone-input-container');
        const otpInputContainer = document.getElementById('otp-input-container');
        const otpCodeInput = document.getElementById('otp-code');
        const otpErrorMsg = document.getElementById('otp-error-message');

        const solarCalculatorSection = document.getElementById('solar-calculator-section');
        const checkoutSummary = document.getElementById('checkout-summary');
        const checkoutTotal = document.getElementById('checkout-total');
        const checkoutForm = document.getElementById('checkout-form');
        const contactForm = document.getElementById('contact-form');
        const solarCalculatorForm = document.getElementById('solar-calculator-form');
        const applianceListDiv = document.getElementById('appliance-list');
        const calculatorResult = document.getElementById('calculator-result');
        const filterButtons = document.getElementById('filter-buttons');
        const addProductForm = document.getElementById('add-product-form');
        const adminProductList = document.getElementById('admin-product-list');
        const adminOrdersList = document.getElementById('admin-orders-list');
        const adminComplaintsList = document.getElementById('admin-complaints-list');
        const noOrdersMessage = document.getElementById('no-orders-message');
        const noComplaintsMessage = document.getElementById('no-complaints-message');
        const adminSection = document.getElementById('admin-section');
        const adminContent = document.getElementById('admin-content');
        const createDealerForm = document.getElementById('create-dealer-form');
        const createDealerError = document.getElementById('dealer-creation-error');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const dealersSection = document.getElementById('dealers-section');
        const dealersContent = document.getElementById('dealers-content');
        const dealersOrdersList = document.getElementById('dealers-orders-list');
        const dealersComplaintsList = document.getElementById('dealers-complaints-list');
        const dealersNoOrdersMessage = document.getElementById('dealers-no-orders-message');
        const dealersNoComplaintsMessage = document.getElementById('dealers-no-complaints-message');
        const dealersLogoutBtn = document.getElementById('dealers-logout-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageBoxOkBtn = document.getElementById('message-box-ok-btn');
        
        // --- Custom message box function ---
        const showMessageBox = (message) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        };

        messageBoxOkBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
        // --- End custom message box function ---

        function updateNavLinks(userRole) {
            // Hide all user-specific links by default
            productsLink.classList.add('hidden');
            calculatorLink.classList.add('hidden');
            contactLink.classList.add('hidden');
            aboutLink.classList.add('hidden');
            cartLink.classList.add('hidden');
            adminLink.classList.add('hidden');
            dealersLink.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            loginBtn.classList.add('hidden');
            
            // Show links based on user role or public access
            if (!userRole) {
                // Public user
                productsLink.classList.remove('hidden');
                calculatorLink.classList.remove('hidden');
                contactLink.classList.remove('hidden');
                aboutLink.classList.remove('hidden');
                loginBtn.classList.remove('hidden');
            } else if (userRole === 'admin') {
                adminLink.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                productsLink.classList.remove('hidden');
                calculatorLink.classList.remove('hidden');
                contactLink.classList.remove('hidden');
                aboutLink.classList.remove('hidden');
            } else if (userRole === 'dealer') {
                dealersLink.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                productsLink.classList.remove('hidden');
                calculatorLink.classList.remove('hidden');
                contactLink.classList.remove('hidden');
                aboutLink.classList.remove('hidden');
            } else if (userRole === 'consumer') {
                productsLink.classList.remove('hidden');
                calculatorLink.classList.remove('hidden');
                contactLink.classList.remove('hidden');
                aboutLink.classList.remove('hidden');
                cartLink.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const userDoc = await getDoc(doc(db, 'users', userId));
                let userRole = userDoc.exists() ? userDoc.data().role : 'consumer';
                updateNavLinks(userRole);
                if (userRole === 'admin') {
                    showSection('admin-section');
                } else if (userRole === 'dealer') {
                    showSection('dealers-section');
                } else {
                    showSection('product-gallery-section');
                }
                setupRealtimeListeners();
            } else {
                userId = null;
                updateNavLinks(null);
                showSection('product-gallery-section');
            }
        });

        function setupRealtimeListeners() {
            // Products Listener
            onSnapshot(collection(db, 'products'), (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProducts();
                renderAdminProducts();
            });
            // Orders Listener
            onSnapshot(collection(db, 'orders'), (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminOrders(orders);
                renderDealersOrders(orders);
            });
            // Complaints Listener
            onSnapshot(collection(db, 'complaints'), (snapshot) => {
                const complaints = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminComplaints(complaints);
                renderDealersComplaints(complaints);
            });
        }
        
        const showSection = (sectionId) => {
            // First, hide all sections
            document.getElementById('product-gallery-section').classList.add('hidden');
            document.getElementById('product-details-section').classList.add('hidden');
            document.getElementById('checkout-section').classList.add('hidden');
            document.getElementById('solar-calculator-section').classList.add('hidden');
            document.getElementById('contact-section').classList.add('hidden');
            document.getElementById('about-section').classList.add('hidden');
            document.getElementById('admin-section').classList.add('hidden');
            document.getElementById('dealers-section').classList.add('hidden');
            document.getElementById('login-modal').classList.add('hidden');

            // Then, show the requested section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        };

        const renderProducts = (filter = 'all') => {
            productGallery.innerHTML = '';
            const filteredProducts = products.filter(product => {
                return filter === 'all' || product.category === filter;
            });
        
            if (filteredProducts.length === 0) {
                productGallery.innerHTML = `<p class="text-center text-gray-600 text-lg col-span-full">No products found in this category. Please add some from the Admin Dashboard.</p>`;
            }
        
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <a href="#" class="product-link" data-product-id="${product.id}">
                        <img src="${product.imageUrls[0]}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/e2e8f0?text=Image+Not+Found';" alt="${product.name}" class="w-full">
                    </a>
                    <div class="p-4">
                        <a href="#" class="product-link" data-product-id="${product.id}">
                            <h3 class="product-name">${product.name}</h3>
                        </a>
                        <p class="product-category">Category: ${product.category}</p>
                        <p class="product-price">₹${product.price.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="p-4 pt-0">
                        <button class="add-to-cart-btn btn w-full btn-primary" data-product-id="${product.id}">Add to Cart</button>
                    </div>
                `;
                productGallery.appendChild(productCard);
            });
        };

        const renderProductDetails = (productId) => {
            const product = products.find(p => product.id == productId);
            if (!product) return;
        
            productMainImage.src = product.imageUrls[0];
            productMainImage.alt = product.name;
            productDetailsName.textContent = product.name;
            productDetailsCategory.textContent = `Category: ${product.category}`;
            productDetailsPrice.textContent = `₹${product.price.toLocaleString('en-IN')}`;
            productDetailsDescription.textContent = product.description;
            addToCartDetailsBtn.dataset.productId = product.id;
        
            productThumbnails.innerHTML = '';
            product.imageUrls.forEach((url, index) => {
                if (url) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.onerror = "this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/e2e8f0?text=Image+Not+Found';";
                    img.alt = `${product.name} thumbnail ${index + 1}`;
                    img.className = `w-16 h-16 rounded-md object-cover thumbnail-image ${index === 0 ? 'active' : ''}`;
                    img.dataset.url = url;
                    productThumbnails.appendChild(img);
                }
            });
            showSection('product-details-section');
        };

        const renderAdminProducts = () => {
            adminProductList.innerHTML = '';
            if (products.length === 0) {
                adminProductList.innerHTML = `<p class="text-center text-gray-600">No products added yet.</p>`;
            }
            products.forEach(product => {
                const productItem = document.createElement('div');
                productItem.className = 'flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm';
                productItem.innerHTML = `
                    <div class="flex-1 mr-4">
                        <p class="font-semibold text-gray-800">${product.name}</p>
                        <p class="text-sm text-gray-600">₹${product.price.toLocaleString('en-IN')} | Category: ${product.category}</p>
                    </div>
                    <button class="btn btn-secondary delete-product-btn" data-product-id="${product.id}">Delete</button>
                `;
                adminProductList.appendChild(productItem);
            });
        };

        const renderAdminOrders = (orders) => {
            adminOrdersList.innerHTML = '';
            if (orders.length === 0) {
                noOrdersMessage.classList.remove('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm space-y-2';
                    const orderItemsHtml = order.items.map(item => `
                        <li class="text-sm text-gray-600">${item.name} x ${item.quantity} (₹${(item.price * item.quantity).toLocaleString('en-IN')})</li>
                    `).join('');

                    orderItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-800">Order ID: ${order.id}</h4>
                            <button class="text-red-500 hover:text-red-700 delete-order-btn" data-order-id="${order.id}">Delete</button>
                        </div>
                        <p class="text-sm text-gray-700"><strong>Customer:</strong> ${order.customerName}</p>
                        <p class="text-sm text-gray-700"><strong>Email:</strong> ${order.email}</p>
                        <p class="text-sm text-gray-700"><strong>Address:</strong> ${order.address}</p>
                        <p class="font-semibold text-gray-800">Total: ₹${order.total.toLocaleString('en-IN')}</p>
                        <ul class="list-disc list-inside mt-2 text-sm">
                            ${orderItemsHtml}
                        </ul>
                    `;
                    adminOrdersList.appendChild(orderItem);
                });
            }
        };

        const renderAdminComplaints = (complaints) => {
            adminComplaintsList.innerHTML = '';
            if (complaints.length === 0) {
                noComplaintsMessage.classList.remove('hidden');
            } else {
                noComplaintsMessage.classList.add('hidden');
                complaints.forEach(complaint => {
                    const complaintItem = document.createElement('div');
                    complaintItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm space-y-2';
                    complaintItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-800">Complaint from ${complaint.name}</h4>
                            <button class="text-red-500 hover:text-red-700 delete-complaint-btn" data-complaint-id="${complaint.id}">Delete</button>
                        </div>
                        <p class="text-sm text-gray-700"><strong>Email:</strong> ${complaint.email}</p>
                        <p class="text-sm text-gray-700"><strong>Message:</strong> ${complaint.message}</p>
                    `;
                    adminComplaintsList.appendChild(complaintItem);
                });
            }
        };

        const renderDealersOrders = (orders) => {
            dealersOrdersList.innerHTML = '';
            if (orders.length === 0) {
                dealersNoOrdersMessage.classList.remove('hidden');
            } else {
                dealersNoOrdersMessage.classList.add('hidden');
                orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm space-y-2';
                    const orderItemsHtml = order.items.map(item => `
                        <li class="text-sm text-gray-600">${item.name} x ${item.quantity} (₹${(item.price * item.quantity).toLocaleString('en-IN')})</li>
                    `).join('');

                    orderItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-800">Order ID: ${order.id}</h4>
                        </div>
                        <p class="text-sm text-gray-700"><strong>Customer:</strong> ${order.customerName}</p>
                        <p class="text-sm text-gray-700"><strong>Email:</strong> ${order.email}</p>
                        <p class="text-sm text-gray-700"><strong>Address:</strong> ${order.address}</p>
                        <p class="font-semibold text-gray-800">Total: ₹${order.total.toLocaleString('en-IN')}</p>
                        <ul class="list-disc list-inside mt-2 text-sm">
                            ${orderItemsHtml}
                        </ul>
                    `;
                    dealersOrdersList.appendChild(orderItem);
                });
            }
        };

        const renderDealersComplaints = (complaints) => {
            dealersComplaintsList.innerHTML = '';
            if (complaints.length === 0) {
                dealersNoComplaintsMessage.classList.remove('hidden');
            } else {
                dealersNoComplaintsMessage.classList.add('hidden');
                complaints.forEach(complaint => {
                    const complaintItem = document.createElement('div');
                    complaintItem.className = 'bg-gray-50 p-4 rounded-lg shadow-sm space-y-2';
                    complaintItem.innerHTML = `
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-gray-800">Complaint from ${complaint.name}</h4>
                        </div>
                        <p class="text-sm text-gray-700"><strong>Email:</strong> ${complaint.email}</p>
                        <p class="text-sm text-gray-700"><strong>Message:</strong> ${complaint.message}</p>
                    `;
                    dealersComplaintsList.appendChild(complaintItem);
                });
            }
        };

        const addToCart = (productId) => {
            const product = products.find(p => product.id == productId);
            if (!product) return;
            
            if (cart[productId]) {
                cart[productId].quantity++;
            } else {
                cart[productId] = { ...product, quantity: 1, imageUrl: product.imageUrls[0] };
            }
            saveCart();
            showMessageBox('Product added to cart!');
        };

        const saveCart = () => {
            localStorage.setItem('solarCart', JSON.stringify(cart));
            updateCartCount();
            renderCart();
        };

        const increaseQuantity = (productId) => {
            if (cart[productId]) {
                cart[productId].quantity++;
                saveCart();
            }
        };

        const decreaseQuantity = (productId) => {
            if (cart[productId] && cart[productId].quantity > 1) {
                cart[productId].quantity--;
                saveCart();
            }
        };

        const removeItem = (productId) => {
            delete cart[productId];
            saveCart();
        };

        const updateCartCount = () => {
            let totalItems = 0;
            for (const productId in cart) {
                totalItems += cart[productId].quantity;
            }
            cartCountElement.textContent = totalItems;
        };

        const renderCart = () => {
            cartItemsContainer.innerHTML = '';
            let total = 0;
            
            if (Object.keys(cart).length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Your cart is empty. Add some products!</p>`;
                modalCheckoutBtn.disabled = true;
                modalCheckoutBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                modalCheckoutBtn.disabled = false;
                modalCheckoutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                for (const id in cart) {
                    const item = cart[id];
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex items-center py-3 border-b border-gray-200 last:border-b-0';
                    itemElement.innerHTML = `
                        <img src="${item.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/e2e8f0?text=Image+Not+Found';" alt="${item.name}" class="w-16 h-16 rounded-md mr-4 object-cover">
                        <div class="flex-1 text-sm">
                            <h4 class="font-semibold text-gray-800">${item.name}</h4>
                            <p class="text-gray-600">₹${item.price.toLocaleString('en-IN')} each</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button class="text-xl font-bold text-gray-500 hover:text-gray-800 focus:outline-none" data-action="decrease" data-product-id="${item.id}">-</button>
                            <span class="font-bold w-6 text-center text-gray-800">${item.quantity}</span>
                            <button class="text-xl font-bold text-gray-500 hover:text-gray-800 focus:outline-none" data-action="increase" data-product-id="${item.id}">+</button>
                        </div>
                        <button class="ml-4 text-red-500 hover:text-red-700 focus:outline-none" data-action="remove" data-product-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    cartItemsContainer.appendChild(itemElement);
                }
            }
            
            cartTotalElement.textContent = `Total: ₹${total.toLocaleString('en-IN')}`;
        };

        const renderCheckoutSummary = () => {
            checkoutSummary.innerHTML = '';
            let total = 0;
            
            if (Object.keys(cart).length === 0) {
                checkoutSummary.innerHTML = `<p class="text-center text-gray-500 py-4">Your cart is empty.</p>`;
            } else {
                for (const id in cart) {
                    const item = cart[id];
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center py-2';
                    itemElement.innerHTML = `
                        <p class="font-semibold text-gray-800">${item.name} <span class="text-gray-500 text-sm">x${item.quantity}</span></p>
                        <p class="font-semibold text-gray-800">₹${itemTotal.toLocaleString('en-IN')}</p>
                    `;
                    checkoutSummary.appendChild(itemElement);
                }
            }
            checkoutTotal.textContent = `Total: ₹${total.toLocaleString('en-IN')}`;
        };

        // Event Listeners for Nav Links
        productsLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('product-gallery-section');
        });
        
        calculatorLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('solar-calculator-section');
        });
        
        contactLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('contact-section');
        });
        
        aboutLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('about-section');
        });
        
        adminLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('admin-section');
        });

        dealersLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('dealers-section');
        });

        loginBtn.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
            loginOptionsContainer.classList.remove('hidden');
            consumerLoginCard.classList.add('hidden');
            consumerSignupCard.classList.add('hidden');
            otpLoginCard.classList.add('hidden');
            adminLoginCard.classList.add('hidden');
            dealerLoginCard.classList.add('hidden');
        });

        closeLoginModalBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });
        
        showConsumerLoginBtn.addEventListener('click', () => {
            loginOptionsContainer.classList.add('hidden');
            consumerLoginCard.classList.remove('hidden');
            consumerLoginErrorMsg.textContent = '';
        });

        showOtpLoginBtn.addEventListener('click', () => {
            loginOptionsContainer.classList.add('hidden');
            otpLoginCard.classList.remove('hidden');
            otpErrorMsg.textContent = '';
        });

        showAdminLoginBtn.addEventListener('click', () => {
            loginOptionsContainer.classList.add('hidden');
            adminLoginCard.classList.remove('hidden');
            document.getElementById('admin-password').value = '';
            document.getElementById('admin-login-error').textContent = '';
        });

        showDealerLoginBtn.addEventListener('click', () => {
            loginOptionsContainer.classList.add('hidden');
            dealerLoginCard.classList.remove('hidden');
            document.getElementById('dealers-email').value = '';
            document.getElementById('dealers-password').value = '';
            document.getElementById('dealers-login-error').textContent = '';
        });

        showSignupFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            consumerLoginCard.classList.add('hidden');
            consumerSignupCard.classList.remove('hidden');
            consumerSignupErrorMsg.textContent = '';
        });

        showLoginFormBtn.addEventListener('click', (e) => {
            e.preventDefault();
            consumerSignupCard.classList.add('hidden');
            consumerLoginCard.classList.remove('hidden');
            consumerLoginErrorMsg.textContent = '';
        });

        productGallery.addEventListener('click', (e) => {
            const productLink = e.target.closest('.product-link');
            if (productLink) {
                e.preventDefault();
                const productId = productLink.dataset.productId;
                renderProductDetails(productId);
            } else if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.productId;
                addToCart(productId);
            }
        });
        
        filterButtons.addEventListener('click', (e) => {
            const filter = e.target.dataset.filter;
            if (filter) {
                renderProducts(filter);
                document.querySelectorAll('#filter-buttons .filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                e.target.classList.add('active');
            }
        });

        cartLink.addEventListener('click', (e) => {
            e.preventDefault();
            renderCart();
            cartModal.classList.remove('hidden');
        });

        closeCartBtn.addEventListener('click', () => {
            cartModal.classList.add('hidden');
        });

        cartItemsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const action = button.dataset.action;
                const productId = button.dataset.productId;
                
                if (action === 'increase') {
                    increaseQuantity(productId);
                } else if (action === 'decrease') {
                    decreaseQuantity(productId);
                } else if (action === 'remove') {
                    removeItem(productId);
                }
            }
        });

        modalCheckoutBtn.addEventListener('click', () => {
            cartModal.classList.add('hidden');
            renderCheckoutSummary();
            showSection('checkout-section');
        });
        
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('admin-password').value;
            const adminLoginError = document.getElementById('admin-login-error');
            adminLoginError.classList.add('hidden');
            if (password === ADMIN_PASSWORD) {
                try {
                    const adminEmail = 'admin@yourcompany.com';
                    const adminPass = 'admin_password_placeholder'; // Placeholder for security
                    const userCredential = await signInWithEmailAndPassword(auth, adminEmail, adminPass);
                    await setDoc(doc(db, 'users', userCredential.user.uid), { role: 'admin' }, { merge: true });
                    loginModal.classList.add('hidden');
                    showMessageBox('Admin logged in successfully!');
                } catch (error) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        try {
                           const userCredential = await createUserWithEmailAndPassword(auth, 'admin@yourcompany.com', 'admin_password_placeholder');
                           await setDoc(doc(db, 'users', userCredential.user.uid), { role: 'admin' });
                           showMessageBox('Admin account created and logged in successfully!');
                           loginModal.classList.add('hidden');
                        } catch (creationError) {
                            adminLoginError.textContent = 'Error logging in as admin. Check the console for details.';
                            adminLoginError.classList.remove('hidden');
                            console.error("Admin creation failed:", creationError);
                        }
                    } else {
                        adminLoginError.textContent = error.message;
                        adminLoginError.classList.remove('hidden');
                    }
                }
            } else {
                adminLoginError.textContent = 'Incorrect password.';
                adminLoginError.classList.remove('hidden');
            }
        });

        adminLogoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showMessageBox('You have been logged out.');
        });
        
        dealersLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('dealers-email').value;
            const password = document.getElementById('dealers-password').value;
            document.getElementById('dealers-login-error').classList.add('hidden');
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
                if (userDoc.exists() && userDoc.data().role === 'dealer') {
                    loginModal.classList.add('hidden');
                    showMessageBox('Dealer logged in successfully!');
                } else {
                    await signOut(auth);
                    document.getElementById('dealers-login-error').textContent = "Invalid email or password.";
                    document.getElementById('dealers-login-error').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('dealers-login-error').textContent = error.message;
                document.getElementById('dealers-login-error').classList.remove('hidden');
            }
        });
        
        dealersLogoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showMessageBox('You have been logged out.');
        });

        createDealerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('dealer-creation-error').classList.add('hidden');
            const email = document.getElementById('dealer-email').value;
            const password = document.getElementById('dealer-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), { role: 'dealer' });
                document.getElementById('create-dealer-form').reset();
                showMessageBox(`Dealer account created successfully for ${email}.`);
            } catch (error) {
                document.getElementById('dealer-creation-error').textContent = error.message;
                document.getElementById('dealer-creation-error').classList.remove('hidden');
            }
        });

        consumerSignupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            document.getElementById('consumer-signup-error').classList.add('hidden');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, 'users', userCredential.user.uid), { role: 'consumer' });
                showMessageBox('Account created successfully! You are now logged in.');
                loginModal.classList.add('hidden');
            } catch (error) {
                document.getElementById('consumer-signup-error').textContent = error.message;
                document.getElementById('consumer-signup-error').classList.remove('hidden');
            }
        });

        consumerLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            document.getElementById('consumer-login-error').classList.add('hidden');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const userDoc = await getDoc(doc(db, 'users', userCredential.user.uid));
                if (userDoc.exists() && userDoc.data().role === 'consumer') {
                    showMessageBox('Logged in successfully!');
                    loginModal.classList.add('hidden');
                } else {
                    await signOut(auth);
                    document.getElementById('consumer-login-error').textContent = "Invalid email or password.";
                    document.getElementById('consumer-login-error').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('consumer-login-error').textContent = error.message;
                document.getElementById('consumer-login-error').classList.remove('hidden');
            }
        });
        
        // OTP login events
        let recaptchaVerifier;
        otpLoginCard.querySelector('#send-otp-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            otpErrorMsg.classList.add('hidden');
            const phoneNumber = document.getElementById('phone-number').value;
            if (!phoneNumber) {
                otpErrorMsg.textContent = 'Please enter a valid phone number.';
                otpErrorMsg.classList.remove('hidden');
                return;
            }

            try {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        // reCAPTCHA solved, continue with phone sign-in
                    }
                });
                const appVerifier = window.recaptchaVerifier;
                confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
                document.getElementById('phone-input-container').classList.add('hidden');
                document.getElementById('otp-input-container').classList.remove('hidden');
                showMessageBox('OTP has been sent to your phone.');
            } catch (error) {
                console.error("Error sending OTP:", error);
                otpErrorMsg.textContent = error.message;
                otpErrorMsg.classList.remove('hidden');
            }
        });

        otpLoginCard.querySelector('#verify-otp-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            otpErrorMsg.classList.add('hidden');
            const otpCode = document.getElementById('otp-code').value;
            if (!otpCode) {
                otpErrorMsg.textContent = 'Please enter the verification code.';
                otpErrorMsg.classList.remove('hidden');
                return;
            }
            try {
                const result = await confirmationResult.confirm(otpCode);
                const user = result.user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) {
                    await setDoc(doc(db, 'users', user.uid), { role: 'consumer' });
                }
                showMessageBox('Logged in successfully!');
                loginModal.classList.add('hidden');
            } catch (error) {
                console.error("Error verifying OTP:", error);
                otpErrorMsg.textContent = error.message;
                otpErrorMsg.classList.remove('hidden');
            }
        });


        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            showMessageBox('You have been logged out.');
        });


        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newProduct = {
                name: document.getElementById('new-product-name').value,
                price: parseFloat(document.getElementById('new-product-price').value),
                category: document.getElementById('new-product-category').value,
                imageUrls: [
                    document.getElementById('new-product-image-1').value,
                    document.getElementById('new-product-image-2').value,
                    document.getElementById('new-product-image-3').value
                ].filter(url => url),
                description: document.getElementById('new-product-description').value
            };
            
            try {
                await addDoc(collection(db, 'products'), newProduct);
                document.getElementById('add-product-form').reset();
                showMessageBox('Product added successfully!');
            } catch (error) {
                console.error("Error adding product: ", error);
                showMessageBox('Failed to add product. Check the console for details.');
            }
        });

        adminProductList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-product-btn')) {
                const productId = e.target.dataset.productId;
                try {
                    await deleteDoc(doc(db, 'products', productId));
                    showMessageBox('Product deleted successfully!');
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showMessageBox('Failed to delete product. Check the console for details.');
                }
            }
        });
        
        adminOrdersList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-order-btn')) {
                const orderId = e.target.dataset.orderId;
                try {
                    await deleteDoc(doc(db, 'orders', orderId));
                    showMessageBox('Order deleted successfully!');
                } catch (error) {
                    console.error("Error deleting order: ", error);
                    showMessageBox('Failed to delete order. Check the console for details.');
                }
            }
        });

        adminComplaintsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-complaint-btn')) {
                const complaintId = e.target.dataset.complaintId;
                try {
                    await deleteDoc(doc(db, 'complaints', complaintId));
                    showMessageBox('Complaint deleted successfully!');
                } catch (error) {
                    console.error("Error deleting complaint: ", error);
                    showMessageBox('Failed to delete complaint. Check the console for details.');
                }
            }
        });

        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('name').value;
            const customerEmail = document.getElementById('email').value;
            const customerAddress = document.getElementById('address').value;
            
            let total = 0;
            const cartItems = [];
            for (const id in cart) {
                const item = cart[id];
                total += item.price * item.quantity;
                cartItems.push({
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                });
            }

            const newOrder = {
                customerName: customerName,
                email: customerEmail,
                address: customerAddress,
                items: cartItems,
                total: total,
                timestamp: new Date().toLocaleString()
            };
            
            try {
                await addDoc(collection(db, 'orders'), newOrder);
                showMessageBox('Thank you for your order! It has been placed successfully.');
                
                localStorage.removeItem('solarCart');
                cart = {};
                updateCartCount();
                checkoutForm.reset();
                showSection('products-link');
            } catch (error) {
                console.error("Error placing order: ", error);
                showMessageBox('Failed to place order. Please try again.');
            }
        });
        
        contactForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const contactName = document.getElementById('contact-name').value;
            const contactEmail = document.getElementById('contact-email').value;
            const contactMessage = document.getElementById('contact-message').value;

            const newComplaint = {
                name: contactName,
                email: contactEmail,
                message: contactMessage,
                timestamp: new Date().toLocaleString()
            };

            try {
                await addDoc(collection(db, 'complaints'), newComplaint);
                showMessageBox('Thank you for your message! We will get back to you soon.');
                contactForm.reset();
            } catch (error) {
                console.error("Error submitting complaint: ", error);
                showMessageBox('Failed to submit complaint. Please try again.');
            }
        });

        backToProductsBtn.addEventListener('click', () => {
            showSection('product-gallery-section');
        });
        
        addToCartDetailsBtn.addEventListener('click', (e) => {
            const productId = e.target.dataset.productId;
            addToCart(productId);
        });

        productThumbnails.addEventListener('click', (e) => {
            if (e.target.tagName === 'IMG') {
                document.querySelectorAll('.thumbnail-image').forEach(img => img.classList.remove('active'));
                e.target.classList.add('active');
                productMainImage.src = e.target.dataset.url;
            }
        });

        // Appliance data with typical wattage
        const appliances = [
            { name: "Light Bulb (LED)", wattage: 10, count: 0 },
            { name: "Ceiling Fan", wattage: 75, count: 0 },
            { name: "Television (LED)", wattage: 100, count: 0 },
            { name: "Refrigerator", wattage: 150, count: 0 },
            { name: "Laptop", wattage: 50, count: 0 },
            { name: "Air Conditioner (1.5 Ton)", wattage: 1500, count: 0 },
            { name: "Water Pump (1 HP)", wattage: 750, count: 0 },
            { name: "Washing Machine", wattage: 2000, count: 0 },
            { name: "Water Heater", wattage: 3000, count: 0 },
            { name: "Microwave Oven", wattage: 1200, count: 0 },
        ];

        // Function to render the appliance list
        const renderApplianceList = () => {
            document.getElementById('appliance-list').innerHTML = appliances.map(appliance => {
                const idSlug = appliance.name.toLowerCase().replace(/[\s\(\)]/g, '-').replace(/[-]{2,}/g, '-');
                return `
                <div class="flex items-center space-x-4">
                    <label class="flex-1 flex items-center text-gray-700">
                        <input type="checkbox" name="appliance" value="${appliance.wattage}" class="form-checkbox h-5 w-5 text-blue-600 rounded" data-appliance-name="${appliance.name}">
                        <span class="ml-2">${appliance.name} (${appliance.wattage}W)</span>
                    </label>
                    <div class="flex items-center space-x-2">
                        <label for="quantity-${idSlug}" class="text-sm font-medium text-gray-500">Qty:</label>
                        <input type="number" id="quantity-${idSlug}" class="form-input w-20 text-center" value="1" min="1" disabled>
                    </div>
                </div>
            `;
            }).join('');
        };

        // Event listener for checkbox changes to enable/disable quantity input
        document.getElementById('appliance-list').addEventListener('change', (e) => {
            if (e.target.type === 'checkbox' && e.target.name === 'appliance') {
                const idSlug = e.target.dataset.applianceName.toLowerCase().replace(/[\s\(\)]/g, '-').replace(/[-]{2,}/g, '-');
                const quantityInput = document.getElementById(`quantity-${idSlug}`);
                quantityInput.disabled = !e.target.checked;
                if(e.target.checked) {
                    quantityInput.value = '1';
                }
            }
        });

        // Event listener for the new solar calculator form
        solarCalculatorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            let totalLoadWatts = 0;
            const selectedAppliances = [];

            document.querySelectorAll('input[name="appliance"]:checked').forEach(checkbox => {
                const applianceName = checkbox.dataset.applianceName;
                const idSlug = applianceName.toLowerCase().replace(/[\s\(\)]/g, '-').replace(/[-]{2,}/g, '-');
                const quantityInput = document.getElementById(`quantity-${idSlug}`);
                const quantity = parseInt(quantityInput.value, 10);
                const wattage = parseInt(checkbox.value, 10);

                if (!isNaN(quantity) && quantity > 0) {
                    totalLoadWatts += wattage * quantity;
                    selectedAppliances.push({ name: applianceName, wattage: wattage, quantity: quantity });
                }
            });

            if (totalLoadWatts === 0) {
                document.getElementById('calculator-result').innerHTML = `<p class="text-red-500">Please select at least one appliance to calculate the load.</p>`;
                return;
            }

            const recommendedLoadWatts = totalLoadWatts * 1.2;
            const recommendedLoadKW = Math.ceil(recommendedLoadWatts / 1000);

            document.getElementById('calculator-result').innerHTML = `
                <div class="space-y-4 text-left">
                    <h3 class="text-xl font-bold text-gray-800">Your Calculated Solar Load:</h3>
                    <p>Total Power Load: <strong>${totalLoadWatts} Watts</strong></p>
                    <p>Recommended Solar System Size: <strong>~${recommendedLoadKW} kW</strong></p>
                    <p class="text-sm text-gray-500 mt-2">
                        This is a useful estimate for the solar system capacity you need to run these appliances. We can help you find a suitable solution.
                    </p>
                </div>
            `;
        });
    </script>
</body>
</html>
